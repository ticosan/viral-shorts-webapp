{% extends "base.html" %}

{% block title %}Descubrimiento Viral - Shorts Manager{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body">
                    <h1 class="mb-0"><i class="fas fa-rocket me-3"></i>Descubrimiento de Videos Virales</h1>
                    <p class="mb-0 opacity-8">Encuentra videos con alto potencial viral y genera shorts autom√°ticamente</p>
                </div>
            </div>
        </div>
    </div>

    <!-- B√∫squeda de Videos -->
    <div class="row">
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5><i class="fas fa-search me-2"></i>Buscar Videos</h5>
                </div>
                <div class="card-body">
                    <form id="searchForm">
                        <div class="mb-3">
                            <label class="form-label">Nicho</label>
                            <select class="form-select" id="nicho" name="nicho">
                                <option value="finanzas">üí∞ Finanzas Personales</option>
                                <option value="tecnologia">üíª Tecnolog√≠a</option>
                                <option value="negocios">üìä Negocios</option>
                                <option value="salud">üèÉ Salud y Fitness</option>
                                <option value="educacion">üìö Educaci√≥n</option>
                                <option value="motivacion">üéØ Motivaci√≥n</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Per√≠odo</label>
                            <select class="form-select" id="periodo" name="periodo">
                                <option value="1">üìÖ √öltimo d√≠a</option>
                                <option value="3" selected>üìÖ √öltimos 3 d√≠as</option>
                                <option value="7">üìÖ √öltima semana</option>
                                <option value="30">üìÖ √öltimo mes</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">VPH M√≠nimo</label>
                            <input type="number" class="form-control" id="vph_minimo" name="vph_minimo" value="100" min="10">
                            <small class="form-text text-muted">Views Per Hour m√≠nimo para considerar viral</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Cantidad de videos</label>
                            <select class="form-select" id="cantidad" name="cantidad">
                                <option value="10">10 videos</option>
                                <option value="21" selected>21 videos (para semana completa)</option>
                                <option value="50">50 videos</option>
                                <option value="100">100 videos</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <i class="fas fa-search me-2"></i>Buscar Videos Virales
                        </button>
                    </form>

                    <div id="searchStatus" class="alert alert-info d-none">
                        <i class="fas fa-spinner fa-spin me-2"></i>Buscando videos virales...
                    </div>

                    <div class="alert alert-warning">
                        <h6><i class="fas fa-key me-2"></i>¬øAPIs configuradas?</h6>
                        <p class="mb-2">Para an√°lisis avanzado con IA, configura OpenAI o Claude</p>
                        <a href="{{ url_for('api_config') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-cog me-1"></i>Configurar APIs
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-video me-2"></i>Videos Encontrados</h5>
                    <div>
                        <button id="analyzeAllBtn" class="btn btn-warning btn-sm d-none">
                            <i class="fas fa-magic me-1"></i>Analizar Todos con IA
                        </button>
                        <button id="generateShortsBtn" class="btn btn-success btn-sm d-none">
                            <i class="fas fa-cut me-1"></i>Generar Shorts Autom√°ticamente
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="videoResults">
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                            <h5>Busca videos para comenzar</h5>
                            <p>Usa los filtros de la izquierda para encontrar videos virales</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Videos Analizados -->
    <div class="row mt-4 d-none" id="analyzedSection">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-brain me-2"></i>Videos Analizados con IA</h5>
                    <button id="createWeekBtn" class="btn btn-primary">
                        <i class="fas fa-calendar-plus me-1"></i>Crear Semana con estos Shorts
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="analyzedResults"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
let currentVideos = [];
let analyzedShorts = [];

document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const searchStatus = document.getElementById('searchStatus');
    const videoResults = document.getElementById('videoResults');
    
    searchStatus.classList.remove('d-none');
    
    try {
        const response = await fetch('/api/search-viral-videos', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        currentVideos = data.videos;
        
        displayVideoResults(data.videos);
        document.getElementById('analyzeAllBtn').classList.remove('d-none');
        
    } catch (error) {
        console.error('Error:', error);
        videoResults.innerHTML = '<div class="p-4 text-danger">Error buscando videos</div>';
    }
    
    searchStatus.classList.add('d-none');
});

function displayVideoResults(videos) {
    const container = document.getElementById('videoResults');
    
    if (videos.length === 0) {
        container.innerHTML = '<div class="p-4 text-muted text-center">No se encontraron videos virales</div>';
        return;
    }
    
    const html = videos.map((video, index) => {
        // Indicador de viralidad basado en VPH
        const viralityLevel = video.vph > 1000 ? 'extreme' : video.vph > 500 ? 'high' : video.vph > 200 ? 'medium' : 'low';
        const viralityColor = viralityLevel === 'extreme' ? 'danger' : viralityLevel === 'high' ? 'warning' : viralityLevel === 'medium' ? 'success' : 'info';
        
        // Indicador de crecimiento del canal
        const channelGrowthBadge = video.channel_growth_indicator === 'explosive' ? 
            '<span class="badge bg-danger ms-1"><i class="fas fa-rocket"></i> Explosivo</span>' :
            video.channel_growth_indicator === 'high_growth' ? 
            '<span class="badge bg-warning ms-1"><i class="fas fa-trending-up"></i> Alto Crecimiento</span>' :
            video.channel_growth_indicator === 'viral_content' ?
            '<span class="badge bg-success ms-1"><i class="fas fa-fire"></i> Viral</span>' : 
            video.channel_growth_indicator === 'emerging' ?
            '<span class="badge bg-info ms-1"><i class="fas fa-seedling"></i> Emergente</span>' : '';
        
        return `
        <div class="border-bottom p-3 video-item ${viralityLevel}-virality" data-video-id="${video.id}">
            <div class="row">
                <div class="col-lg-3">
                    <div class="position-relative">
                        <img src="${video.thumbnail}" class="img-fluid rounded" alt="Thumbnail">
                        <div class="position-absolute top-0 start-0 p-1">
                            <span class="badge bg-dark">#${index + 1}</span>
                        </div>
                        <div class="position-absolute bottom-0 end-0 p-1">
                            <span class="badge bg-dark">${video.duration_formatted}</span>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <h6 class="mb-2 text-truncate" title="${video.title}">
                        ${video.title}
                    </h6>
                    <p class="text-muted small mb-2">
                        <i class="fas fa-user me-1"></i>${video.channel}
                        ${channelGrowthBadge}
                    </p>
                    
                    <!-- M√©tricas principales -->
                    <div class="mb-2">
                        <span class="badge bg-${viralityColor} me-1" title="Views Per Hour - M√©trica principal de viralidad">
                            üî• VPH: ${video.vph.toLocaleString()}
                        </span>
                        <span class="badge bg-primary me-1" title="Views totales">
                            üëÅÔ∏è ${video.views_formatted}
                        </span>
                        <span class="badge bg-success me-1" title="Engagement Score">
                            üìä ENG: ${video.engagement_score}
                        </span>
                    </div>
                    
                    <!-- M√©tricas avanzadas -->
                    <div class="small text-muted mb-2">
                        <span class="me-3" title="Views por d√≠a">üìÖ ${video.views_per_day.toLocaleString()}/d√≠a</span>
                        <span class="me-3" title="Likes por cada 1000 views">üëç ${video.likes_per_view_1k}/1k</span>
                        <span class="me-3" title="Comentarios por cada 1000 views">üí¨ ${video.comments_per_view_1k}/1k</span>
                        <span title="Puntuaci√≥n viral compuesta">‚≠ê ${video.viral_score}</span>
                    </div>
                    
                    <!-- Informaci√≥n temporal -->
                    <div class="small text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Publicado: ${video.published_formatted} 
                        <span class="ms-2">(${video.horas_transcurridas}h transcurridas)</span>
                    </div>
                    
                    <!-- Informaci√≥n del canal -->
                    <div class="small text-muted mt-1">
                        <i class="fas fa-users me-1"></i>
                        Suscriptores: ${video.channel_subscribers?.toLocaleString() || 'N/A'}
                        <span class="ms-2">Potencial viral: ${video.channel_viral_potential || 0}%</span>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="analyzeVideo('${video.id}', '${video.title}')">
                            <i class="fas fa-brain me-1"></i>Analizar con IA
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="generateShorts('${video.id}', '${video.title}')">
                            <i class="fas fa-cut me-1"></i>Generar Shorts
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="viewDetails('${video.id}')">
                            <i class="fas fa-eye me-1"></i>Ver Detalles
                        </button>
                        <a href="${video.url}" target="_blank" class="btn btn-outline-secondary btn-sm">
                            <i class="fab fa-youtube me-1"></i>Ver en YouTube
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    }).join('');
    
    container.innerHTML = html;
    
    // Mostrar estad√≠sticas del lote
    const avgVph = videos.reduce((sum, v) => sum + v.vph, 0) / videos.length;
    const avgEngagement = videos.reduce((sum, v) => sum + v.engagement_score, 0) / videos.length;
    const explosiveChannels = videos.filter(v => v.channel_growth_indicator === 'explosive').length;
    
    // A√±adir resumen estad√≠stico
    container.insertAdjacentHTML('afterbegin', `
        <div class="alert alert-info mb-3">
            <div class="row text-center">
                <div class="col-md-3">
                    <strong>${videos.length}</strong><br>
                    <small>Videos encontrados</small>
                </div>
                <div class="col-md-3">
                    <strong>${avgVph.toLocaleString()}</strong><br>
                    <small>VPH promedio</small>
                </div>
                <div class="col-md-3">
                    <strong>${avgEngagement.toFixed(1)}</strong><br>
                    <small>Engagement promedio</small>
                </div>
                <div class="col-md-3">
                    <strong>${explosiveChannels}</strong><br>
                    <small>Canales explosivos</small>
                </div>
            </div>
        </div>
    `);
}

async function analyzeVideo(videoId, videoTitle) {
    try {
        const button = document.querySelector(`button[onclick="analyzeVideo('${videoId}', '${videoTitle}')"]`);
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analizando...';
        button.disabled = true;
        
        const response = await fetch('/api/analyze-video', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                video_id: videoId,
                video_title: videoTitle
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            button.innerHTML = '<i class="fas fa-check me-1"></i>Analizado';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-success');
            
            // Mostrar resultados del an√°lisis
            showAnalysisResults(videoId, data.analysis);
            
            // Habilitar bot√≥n de generar shorts
            const generateBtn = document.querySelector(`button[onclick="generateShorts('${videoId}', '${videoTitle}')"]`);
            generateBtn.classList.remove('btn-outline-success');
            generateBtn.classList.add('btn-warning');
            generateBtn.innerHTML = '<i class="fas fa-magic me-1"></i>¬°Generar Shorts!';
            
        } else {
            throw new Error(data.error);
        }
        
    } catch (error) {
        console.error('Error:', error);
        button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
        button.classList.add('btn-danger');
        alert('Error analizando video: ' + error.message);
    }
}

async function generateShorts(videoId, videoTitle) {
    try {
        const button = document.querySelector(`button[onclick="generateShorts('${videoId}', '${videoTitle}')"]`);
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando...';
        button.disabled = true;
        
        const response = await fetch('/api/generate-shorts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                video_id: videoId,
                video_title: videoTitle
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            button.innerHTML = `<i class="fas fa-check me-1"></i>${data.shorts_generated} Shorts Creados`;
            button.classList.remove('btn-outline-success', 'btn-warning');
            button.classList.add('btn-success');
            
            // Mostrar shorts generados
            showShortsGenerated(videoId, data.shorts);
            
            // Actualizar contador global
            updateShortsCounter(data.shorts_generated);
            
        } else {
            throw new Error(data.error);
        }
        
    } catch (error) {
        console.error('Error:', error);
        button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
        button.classList.add('btn-danger');
        alert('Error generando shorts: ' + error.message);
    }
}

async function viewDetails(videoId) {
    try {
        const response = await fetch(`/api/video-details/${videoId}`);
        const data = await response.json();
        
        if (data.success) {
            showVideoDetailsModal(data.video_info, data.shorts);
        } else {
            throw new Error(data.error);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error cargando detalles: ' + error.message);
    }
}

function showAnalysisResults(videoId, analysis) {
    const videoItem = document.querySelector(`[data-video-id="${videoId}"]`);
    
    // A√±adir panel de an√°lisis
    const analysisPanel = document.createElement('div');
    analysisPanel.className = 'mt-3 p-3 bg-light rounded';
    analysisPanel.innerHTML = `
        <h6><i class="fas fa-brain me-2"></i>An√°lisis IA Completado</h6>
        <div class="row">
            <div class="col-md-6">
                <strong>Nicho:</strong> ${analysis.nicho}<br>
                <strong>Potencial Viral:</strong> ${analysis.potencial_viral}%
            </div>
            <div class="col-md-6">
                <strong>Momentos Virales:</strong> ${analysis.momentos_virales.length}<br>
                <strong>Estado:</strong> <span class="badge bg-success">Listo para generar</span>
            </div>
        </div>
        <div class="mt-2">
            <small class="text-muted">${analysis.resumen_general}</small>
        </div>
    `;
    
    videoItem.appendChild(analysisPanel);
}

function showShortsGenerated(videoId, shorts) {
    const videoItem = document.querySelector(`[data-video-id="${videoId}"]`);
    
    // A√±adir panel de shorts generados
    const shortsPanel = document.createElement('div');
    shortsPanel.className = 'mt-3 p-3 bg-success bg-opacity-10 rounded border border-success';
    shortsPanel.innerHTML = `
        <h6><i class="fas fa-cut me-2"></i>Shorts Generados (${shorts.length})</h6>
        ${shorts.map((short, index) => `
            <div class="mb-2 p-2 bg-white rounded">
                <strong>Short #${index + 1}:</strong> ${short.titulo}<br>
                <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>${short.timestamp}
                    <i class="fas fa-quote-left ms-2 me-1"></i>${short.hook.substring(0, 50)}...
                </small>
            </div>
        `).join('')}
        <div class="mt-2">
            <button class="btn btn-sm btn-primary me-2" onclick="viewDetails('${videoId}')">
                <i class="fas fa-eye me-1"></i>Ver Todos los Detalles
            </button>
            <button class="btn btn-sm btn-success" onclick="createWeekWithShorts()">
                <i class="fas fa-calendar-plus me-1"></i>Crear Semana
            </button>
        </div>
    `;
    
    videoItem.appendChild(shortsPanel);
}

function showVideoDetailsModal(videoInfo, shorts) {
    // Crear modal con detalles completos
    const modalHtml = `
        <div class="modal fade" id="videoDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fab fa-youtube me-2"></i>
                            ${videoInfo.title}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-4">
                                <img src="${videoInfo.thumbnail}" class="img-fluid rounded mb-3">
                                <h6>Informaci√≥n del Video</h6>
                                <p><strong>Canal:</strong> ${videoInfo.channel}</p>
                                <p><strong>Views:</strong> ${videoInfo.views.toLocaleString()}</p>
                                <p><strong>Likes:</strong> ${videoInfo.likes.toLocaleString()}</p>
                                <p><strong>Duraci√≥n:</strong> ${videoInfo.duration}</p>
                                <a href="${videoInfo.url}" target="_blank" class="btn btn-danger btn-sm">
                                    <i class="fab fa-youtube me-1"></i>Ver en YouTube
                                </a>
                            </div>
                            <div class="col-md-8">
                                <h6>Shorts Generados (${shorts.length})</h6>
                                ${shorts.length > 0 ? shorts.map(short => `
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">${short.titulo}</h6>
                                            <p class="card-text">${short.descripcion}</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small><strong>Timestamp:</strong> ${short.timestamp_inicio} - ${short.timestamp_fin}</small><br>
                                                    <small><strong>Estado:</strong> <span class="badge bg-info">${short.estado}</span></small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small><strong>Hook:</strong> ${short.hook}</small>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">${short.momento_viral}</small>
                                            </div>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-primary" onclick="generateScriptFile(${short.id})">
                                                    <i class="fas fa-file-markdown me-1"></i>Generar .md
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-muted">No hay shorts generados a√∫n</p>'}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        ${shorts.length > 0 ? '<button type="button" class="btn btn-success" onclick="createWeekWithShorts()">Crear Semana con estos Shorts</button>' : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // A√±adir modal al DOM y mostrarlo
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('videoDetailsModal'));
    modal.show();
    
    // Limpiar modal cuando se cierre
    document.getElementById('videoDetailsModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

let totalShortsGenerated = 0;

function updateShortsCounter(count) {
    totalShortsGenerated += count;
    
    if (totalShortsGenerated >= 21) {
        showCreateWeekNotification();
    }
}

function showCreateWeekNotification() {
    if (document.getElementById('weekNotification')) return; // Ya existe
    
    const notification = document.createElement('div');
    notification.id = 'weekNotification';
    notification.className = 'alert alert-success alert-dismissible position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <strong><i class="fas fa-party-horn me-2"></i>¬°Semana Completa!</strong><br>
        Has generado ${totalShortsGenerated} shorts. ¬°Perfecto para una semana completa!
        <button type="button" class="btn btn-sm btn-success ms-2" onclick="createWeekWithShorts()">
            <i class="fas fa-calendar-plus me-1"></i>Crear Semana
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide despu√©s de 10 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 10000);
}

function createWeekWithShorts() {
    // Redirigir a creaci√≥n de semana con shorts generados
    window.location.href = '/crear-semana-con-shorts';
}

async function generateScriptFile(shortId) {
    try {
        const button = document.querySelector(`button[onclick="generateScriptFile(${shortId})"]`);
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando...';
        button.disabled = true;
        
        const response = await fetch(`/api/generate-script-file/${shortId}`);
        const data = await response.json();
        
        if (data.success) {
            button.innerHTML = '<i class="fas fa-check me-1"></i>Generado';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-success');
            
            // Mostrar modal con el contenido generado
            showScriptPreview(data.filename, data.content);
            
            // Mostrar notificaci√≥n de √©xito
            showNotification('success', `‚úÖ Gui√≥n generado: ${data.filename}`);
            
        } else {
            throw new Error(data.error);
        }
        
    } catch (error) {
        console.error('Error:', error);
        button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
        button.classList.add('btn-danger');
        showNotification('error', 'Error generando gui√≥n: ' + error.message);
    }
}

function showScriptPreview(filename, content) {
    const modalHtml = `
        <div class="modal fade" id="scriptPreviewModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-file-markdown me-2"></i>
                            Gui√≥n Generado: ${filename}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <button class="btn btn-outline-primary me-2" onclick="copyToClipboard('${content.replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy me-1"></i>Copiar Contenido
                            </button>
                            <button class="btn btn-outline-success" onclick="downloadScript('${filename}', '${content.replace(/'/g, "\\'")}')">
                                <i class="fas fa-download me-1"></i>Descargar .md
                            </button>
                        </div>
                        <div class="bg-light p-3 rounded" style="max-height: 60vh; overflow-y: auto;">
                            <pre style="white-space: pre-wrap; font-size: 0.9em;">${content}</pre>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // A√±adir modal al DOM y mostrarlo
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('scriptPreviewModal'));
    modal.show();
    
    // Limpiar modal cuando se cierre
    document.getElementById('scriptPreviewModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('success', '‚úÖ Contenido copiado al portapapeles');
    }).catch(err => {
        console.error('Error copying text: ', err);
        showNotification('error', '‚ùå Error copiando contenido');
    });
}

function downloadScript(filename, content) {
    const element = document.createElement('a');
    const file = new Blob([content], { type: 'text/markdown' });
    element.href = URL.createObjectURL(file);
    element.download = filename;
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
    showNotification('success', `‚úÖ Descargado: ${filename}`);
}

function showNotification(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide despu√©s de 5 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>

<style>
.video-item:hover {
    background-color: #f8f9fa;
}

.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #6610f2);
}

/* Categor√≠as de viralidad */
.video-item.extreme-virality {
    border-left: 5px solid #dc3545 !important;
    background: linear-gradient(90deg, #fff5f5 0%, transparent 100%);
}

.video-item.high-virality {
    border-left: 5px solid #fd7e14 !important;
    background: linear-gradient(90deg, #fff8f0 0%, transparent 100%);
}

.video-item.medium-virality {
    border-left: 5px solid #198754 !important;
    background: linear-gradient(90deg, #f0fff4 0%, transparent 100%);
}

.video-item.low-virality {
    border-left: 5px solid #0dcaf0 !important;
    background: linear-gradient(90deg, #f0fcff 0%, transparent 100%);
}

/* Animaci√≥n para videos extremadamente virales */
.extreme-virality .badge.bg-danger {
    animation: pulse-viral 2s ease-in-out infinite;
}

@keyframes pulse-viral {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* Mejoras en thumbnails */
.video-item img {
    transition: transform 0.3s ease;
}

.video-item:hover img {
    transform: scale(1.02);
}

/* Badges con gradientes */
.badge.bg-danger {
    background: linear-gradient(45deg, #dc3545, #ff6b7a) !important;
}

.badge.bg-warning {
    background: linear-gradient(45deg, #fd7e14, #ffab47) !important;
}

.badge.bg-success {
    background: linear-gradient(45deg, #198754, #4ade80) !important;
}

/* Loading states */
.searching {
    position: relative;
    overflow: hidden;
}

.searching::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: searching 1.5s infinite;
}

@keyframes searching {
    0% { left: -100%; }
    100% { left: 100%; }
}
</style>
{% endblock %}