{% extends "base.html" %}

{% block title %}Descubrimiento Viral - Shorts Manager{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body">
                    <h1 class="mb-0"><i class="fas fa-rocket me-3"></i>Descubrimiento de Videos Virales</h1>
                    <p class="mb-0 opacity-8">Encuentra videos con alto potencial viral y genera shorts autom√°ticamente</p>
                </div>
            </div>
        </div>
    </div>

    <!-- B√∫squeda de Videos -->
    <div class="row">
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5><i class="fas fa-search me-2"></i>Buscar Videos</h5>
                </div>
                <div class="card-body">
                    <form id="searchForm">
                        <div class="mb-3">
                            <label class="form-label">Nicho</label>
                            <select class="form-select" id="nicho" name="nicho">
                                <option value="finanzas">üí∞ Finanzas Personales</option>
                                <option value="tecnologia">üíª Tecnolog√≠a</option>
                                <option value="negocios">üìä Negocios</option>
                                <option value="salud">üèÉ Salud y Fitness</option>
                                <option value="educacion">üìö Educaci√≥n</option>
                                <option value="motivacion">üéØ Motivaci√≥n</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Per√≠odo</label>
                            <select class="form-select" id="periodo" name="periodo">
                                <option value="1">üìÖ √öltimo d√≠a</option>
                                <option value="3" selected>üìÖ √öltimos 3 d√≠as</option>
                                <option value="7">üìÖ √öltima semana</option>
                                <option value="30">üìÖ √öltimo mes</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">VPH M√≠nimo</label>
                            <input type="number" class="form-control" id="vph_minimo" name="vph_minimo" value="100" min="10">
                            <small class="form-text text-muted">Views Per Hour m√≠nimo para considerar viral</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Cantidad de videos</label>
                            <select class="form-select" id="cantidad" name="cantidad">
                                <option value="10">10 videos</option>
                                <option value="21" selected>21 videos (para semana completa)</option>
                                <option value="50">50 videos</option>
                                <option value="100">100 videos</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <i class="fas fa-search me-2"></i>Buscar Videos Virales
                        </button>
                    </form>

                    <div id="searchStatus" class="alert alert-info d-none">
                        <i class="fas fa-spinner fa-spin me-2"></i>Buscando videos virales...
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-video me-2"></i>Videos Encontrados</h5>
                    <div>
                        <button id="analyzeAllBtn" class="btn btn-warning btn-sm d-none">
                            <i class="fas fa-magic me-1"></i>Analizar Todos con IA
                        </button>
                        <button id="generateShortsBtn" class="btn btn-success btn-sm d-none">
                            <i class="fas fa-cut me-1"></i>Generar Shorts Autom√°ticamente
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="videoResults">
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                            <h5>Busca videos para comenzar</h5>
                            <p>Usa los filtros de la izquierda para encontrar videos virales</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Videos Analizados -->
    <div class="row mt-4 d-none" id="analyzedSection">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-brain me-2"></i>Videos Analizados con IA</h5>
                    <button id="createWeekBtn" class="btn btn-primary">
                        <i class="fas fa-calendar-plus me-1"></i>Crear Semana con estos Shorts
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="analyzedResults"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
let currentVideos = [];
let analyzedShorts = [];

document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const searchStatus = document.getElementById('searchStatus');
    const videoResults = document.getElementById('videoResults');
    
    searchStatus.classList.remove('d-none');
    
    try {
        const response = await fetch('/api/search-viral-videos', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        currentVideos = data.videos;
        
        displayVideoResults(data.videos);
        document.getElementById('analyzeAllBtn').classList.remove('d-none');
        
    } catch (error) {
        console.error('Error:', error);
        videoResults.innerHTML = '<div class="p-4 text-danger">Error buscando videos</div>';
    }
    
    searchStatus.classList.add('d-none');
});

function displayVideoResults(videos) {
    const container = document.getElementById('videoResults');
    
    if (videos.length === 0) {
        container.innerHTML = '<div class="p-4 text-muted text-center">No se encontraron videos virales</div>';
        return;
    }
    
    const html = videos.map((video, index) => {
        // Indicador de viralidad basado en VPH
        const viralityLevel = video.vph > 1000 ? 'extreme' : video.vph > 500 ? 'high' : video.vph > 200 ? 'medium' : 'low';
        const viralityColor = viralityLevel === 'extreme' ? 'danger' : viralityLevel === 'high' ? 'warning' : viralityLevel === 'medium' ? 'success' : 'info';
        
        // Indicador de crecimiento del canal
        const channelGrowthBadge = video.channel_growth_indicator === 'explosive' ? 
            '<span class="badge bg-danger ms-1"><i class="fas fa-rocket"></i> Explosivo</span>' :
            video.channel_growth_indicator === 'high_growth' ? 
            '<span class="badge bg-warning ms-1"><i class="fas fa-trending-up"></i> Alto Crecimiento</span>' :
            video.channel_growth_indicator === 'viral_content' ?
            '<span class="badge bg-success ms-1"><i class="fas fa-fire"></i> Viral</span>' : 
            video.channel_growth_indicator === 'emerging' ?
            '<span class="badge bg-info ms-1"><i class="fas fa-seedling"></i> Emergente</span>' : '';
        
        return `
        <div class="border-bottom p-3 video-item ${viralityLevel}-virality" data-video-id="${video.id}">
            <div class="row">
                <div class="col-lg-3">
                    <div class="position-relative">
                        <img src="${video.thumbnail}" class="img-fluid rounded" alt="Thumbnail">
                        <div class="position-absolute top-0 start-0 p-1">
                            <span class="badge bg-dark">#${index + 1}</span>
                        </div>
                        <div class="position-absolute bottom-0 end-0 p-1">
                            <span class="badge bg-dark">${video.duration_formatted}</span>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <h6 class="mb-2 text-truncate" title="${video.title}">
                        ${video.title}
                    </h6>
                    <p class="text-muted small mb-2">
                        <i class="fas fa-user me-1"></i>${video.channel}
                        ${channelGrowthBadge}
                    </p>
                    
                    <!-- M√©tricas principales -->
                    <div class="mb-2">
                        <span class="badge bg-${viralityColor} me-1" title="Views Per Hour - M√©trica principal de viralidad">
                            üî• VPH: ${video.vph.toLocaleString()}
                        </span>
                        <span class="badge bg-primary me-1" title="Views totales">
                            üëÅÔ∏è ${video.views_formatted}
                        </span>
                        <span class="badge bg-success me-1" title="Engagement Score">
                            üìä ENG: ${video.engagement_score}
                        </span>
                    </div>
                    
                    <!-- M√©tricas avanzadas -->
                    <div class="small text-muted mb-2">
                        <span class="me-3" title="Views por d√≠a">üìÖ ${video.views_per_day.toLocaleString()}/d√≠a</span>
                        <span class="me-3" title="Likes por cada 1000 views">üëç ${video.likes_per_view_1k}/1k</span>
                        <span class="me-3" title="Comentarios por cada 1000 views">üí¨ ${video.comments_per_view_1k}/1k</span>
                        <span title="Puntuaci√≥n viral compuesta">‚≠ê ${video.viral_score}</span>
                    </div>
                    
                    <!-- Informaci√≥n temporal -->
                    <div class="small text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Publicado: ${video.published_formatted} 
                        <span class="ms-2">(${video.horas_transcurridas}h transcurridas)</span>
                    </div>
                    
                    <!-- Informaci√≥n del canal -->
                    <div class="small text-muted mt-1">
                        <i class="fas fa-users me-1"></i>
                        Suscriptores: ${video.channel_subscribers?.toLocaleString() || 'N/A'}
                        <span class="ms-2">Potencial viral: ${video.channel_viral_potential || 0}%</span>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="analyzeVideo('${video.id}', '${video.title}')">
                            <i class="fas fa-brain me-1"></i>Analizar con IA
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="generateShorts('${video.id}', '${video.title}')">
                            <i class="fas fa-cut me-1"></i>Generar Shorts
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="viewDetails('${video.id}')">
                            <i class="fas fa-eye me-1"></i>Ver Detalles
                        </button>
                        <a href="${video.url}" target="_blank" class="btn btn-outline-secondary btn-sm">
                            <i class="fab fa-youtube me-1"></i>Ver en YouTube
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    }).join('');
    
    container.innerHTML = html;
    
    // Mostrar estad√≠sticas del lote
    const avgVph = videos.reduce((sum, v) => sum + v.vph, 0) / videos.length;
    const avgEngagement = videos.reduce((sum, v) => sum + v.engagement_score, 0) / videos.length;
    const explosiveChannels = videos.filter(v => v.channel_growth_indicator === 'explosive').length;
    
    // A√±adir resumen estad√≠stico
    container.insertAdjacentHTML('afterbegin', `
        <div class="alert alert-info mb-3">
            <div class="row text-center">
                <div class="col-md-3">
                    <strong>${videos.length}</strong><br>
                    <small>Videos encontrados</small>
                </div>
                <div class="col-md-3">
                    <strong>${avgVph.toLocaleString()}</strong><br>
                    <small>VPH promedio</small>
                </div>
                <div class="col-md-3">
                    <strong>${avgEngagement.toFixed(1)}</strong><br>
                    <small>Engagement promedio</small>
                </div>
                <div class="col-md-3">
                    <strong>${explosiveChannels}</strong><br>
                    <small>Canales explosivos</small>
                </div>
            </div>
        </div>
    `);
}

async function analyzeVideo(videoId) {
    // Implementar an√°lisis individual
    console.log('Analizando video:', videoId);
}

async function generateShorts(videoId) {
    // Implementar generaci√≥n individual
    console.log('Generando shorts para video:', videoId);
}
</script>

<style>
.video-item:hover {
    background-color: #f8f9fa;
}

.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #6610f2);
}

/* Categor√≠as de viralidad */
.video-item.extreme-virality {
    border-left: 5px solid #dc3545 !important;
    background: linear-gradient(90deg, #fff5f5 0%, transparent 100%);
}

.video-item.high-virality {
    border-left: 5px solid #fd7e14 !important;
    background: linear-gradient(90deg, #fff8f0 0%, transparent 100%);
}

.video-item.medium-virality {
    border-left: 5px solid #198754 !important;
    background: linear-gradient(90deg, #f0fff4 0%, transparent 100%);
}

.video-item.low-virality {
    border-left: 5px solid #0dcaf0 !important;
    background: linear-gradient(90deg, #f0fcff 0%, transparent 100%);
}

/* Animaci√≥n para videos extremadamente virales */
.extreme-virality .badge.bg-danger {
    animation: pulse-viral 2s ease-in-out infinite;
}

@keyframes pulse-viral {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* Mejoras en thumbnails */
.video-item img {
    transition: transform 0.3s ease;
}

.video-item:hover img {
    transform: scale(1.02);
}

/* Badges con gradientes */
.badge.bg-danger {
    background: linear-gradient(45deg, #dc3545, #ff6b7a) !important;
}

.badge.bg-warning {
    background: linear-gradient(45deg, #fd7e14, #ffab47) !important;
}

.badge.bg-success {
    background: linear-gradient(45deg, #198754, #4ade80) !important;
}

/* Loading states */
.searching {
    position: relative;
    overflow: hidden;
}

.searching::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: searching 1.5s infinite;
}

@keyframes searching {
    0% { left: -100%; }
    100% { left: 100%; }
}
</style>
{% endblock %}