{% extends "base.html" %}

{% block title %}Dashboard - Viral Shorts Manager{% endblock %}

{% block content %}
<!-- Header con selector de semana -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        {% if semana_actual %}
        <h1><i class="fas fa-calendar-week me-2"></i>Semana {{ semana_actual.numero_semana }} - {{ semana_actual.mes }} {{ semana_actual.año }}</h1>
        <p class="text-muted mb-0">
            <i class="fas fa-calendar-alt me-1"></i>
            {{ semana_actual.fecha_inicio.strftime('%d/%m') }} - {{ semana_actual.fecha_fin.strftime('%d/%m/%Y') }}
            <span class="badge bg-{{ 'success' if semana_actual.estado == 'activa' else 'secondary' if semana_actual.estado == 'planificacion' else 'info' }} ms-2">
                {{ semana_actual.estado.title() }}
            </span>
        </p>
        {% else %}
        <h1><i class="fas fa-exclamation-triangle me-2"></i>Error cargando semana</h1>
        <p class="text-danger">{{ error_message if error_message else 'No se pudo cargar la información de la semana' }}</p>
        {% endif %}
    </div>
    
    {% if todas_semanas %}
    <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-exchange-alt me-1"></i>Cambiar Semana
        </button>
        <ul class="dropdown-menu">
            {% for semana in todas_semanas %}
            <li>
                <a class="dropdown-item {% if semana_actual and semana.id == semana_actual.id %}active{% endif %}" 
                   href="/?semana_id={{ semana.id }}">
                    Semana {{ semana.numero_semana }} - {{ semana.mes }} {{ semana.año }}
                    <br><small class="text-muted">{{ semana.fecha_inicio.strftime('%d/%m') }} - {{ semana.fecha_fin.strftime('%d/%m') }}</small>
                </a>
            </li>
            {% endfor %}
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item" href="/nueva_semana">
                    <i class="fas fa-plus me-1"></i>Nueva Semana
                </a>
            </li>
        </ul>
    </div>
    {% endif %}
</div>

<!-- Estadísticas Resumen -->
{% if stats %}
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card text-center bg-primary text-white">
            <div class="card-body">
                <i class="fas fa-video fa-2x mb-2"></i>
                <h3>{{ stats.total_shorts or 0 }}</h3>
                <p class="mb-0">Planificados</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center bg-info text-white">
            <div class="card-body">
                <i class="fas fa-search fa-2x mb-2"></i>
                <h3>{{ stats.investigacion or 0 }}</h3>
                <p class="mb-0">Investigación</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center bg-warning text-white">
            <div class="card-body">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h3>{{ stats.en_proceso or 0 }}</h3>
                <p class="mb-0">En Proceso</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center bg-success text-white">
            <div class="card-body">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h3>{{ stats.completados or 0 }}</h3>
                <p class="mb-0">Completados</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center bg-dark text-white">
            <div class="card-body">
                <i class="fas fa-percentage fa-2x mb-2"></i>
                <h3>{{ stats.progreso or 0 }}%</h3>
                <p class="mb-0">Progreso</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center bg-secondary text-white">
            <div class="card-body">
                <i class="fas fa-target fa-2x mb-2"></i>
                <h3>{{ semana_actual.videos_objetivo if semana_actual else 0 }}</h3>
                <p class="mb-0">Objetivo</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Barra de progreso semanal -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Progreso de la Semana</h6>
            <small class="text-muted">{{ stats.completados }} de {{ semana_actual.videos_objetivo }} videos completados</small>
        </div>
        <div class="progress" style="height: 10px;">
            <div class="progress-bar bg-success" style="width: {{ stats.progreso }}%"></div>
        </div>
    </div>
</div>

<!-- Botones de acción rápida -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex gap-2 justify-content-center flex-wrap">
            <a href="/planificar_semana?semana_id={{ semana_actual.id }}" class="btn btn-primary">
                <i class="fas fa-calendar-plus me-1"></i>Planificar Semana (21 videos)
            </a>
            <a href="/buscar_videos" class="btn btn-success">
                <i class="fas fa-search me-1"></i>Investigar Videos
            </a>
            <a href="/generar_guiones_masivo?semana_id={{ semana_actual.id }}" class="btn btn-warning">
                <i class="fas fa-magic me-1"></i>Generar Guiones Masivo
            </a>
            <button class="btn btn-info" onclick="descargarVideosPendientes()">
                <i class="fas fa-download me-1"></i>Descargar Videos
            </button>
            <a href="/gestionar_pendientes?semana_id={{ semana_actual.id }}" class="btn btn-danger">
                <i class="fas fa-exclamation-triangle me-1"></i>Gestionar Pendientes
            </a>
        </div>
    </div>
</div>

<!-- Shorts por Día (3 por día) -->
{% for dia in dias_orden %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-calendar-day me-2"></i>
            {{ dia.title() }}
            {% set fecha_dia = semana_actual.fecha_inicio + loop.index0 * timedelta(days=1) %}
            <small class="text-muted ms-2">{{ fecha_dia.strftime('%d/%m') }}</small>
        </h5>
        {% set dia_shorts = shorts_por_dia[dia] %}
        <div>
            <span class="badge bg-secondary me-2">
                {{ dia_shorts|selectattr('estado', 'equalto', 'completado')|list|length }}/3 completados
            </span>
            <button class="btn btn-sm btn-outline-primary" onclick="crearShortsDia('{{ dia }}', '{{ fecha_dia }}')">
                <i class="fas fa-plus me-1"></i>Crear 3 Shorts
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Short #1 del día -->
            {% set short1 = dia_shorts|selectattr('orden_dia', 'equalto', 1)|first %}
            <div class="col-md-4">
                {% if short1 %}
                <div class="card border-{{ 'success' if short1.estado == 'completado' else 'warning' if short1.estado in ['en_proceso', 'guion_generado'] else 'info' if short1.estado == 'investigacion' else 'secondary' }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title">{{ dia.title() }} #1</h6>
                            <span class="badge bg-{{ 'success' if short1.estado == 'completado' else 'warning' if short1.estado in ['en_proceso', 'guion_generado'] else 'info' if short1.estado == 'investigacion' else 'secondary' }}">
                                {{ short1.estado.replace('_', ' ').title() }}
                            </span>
                        </div>
                        <p class="card-text text-truncate">{{ short1.titulo }}</p>
                        <small class="text-muted d-block mb-2">{{ short1.tema.title() }} • VPH: {{ short1.vph_fuente|int }}</small>
                        <div class="btn-group w-100" role="group">
                            <a href="{{ url_for('ver_short', short_id=short1.id) }}" class="btn btn-sm btn-outline-primary">Ver</a>
                            <button class="btn btn-sm btn-outline-success" onclick="cambiarEstado({{ short1.id }}, 'en_proceso')">Producir</button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card border-light">
                    <div class="card-body text-center text-muted">
                        <i class="fas fa-plus-circle fa-2x mb-2"></i>
                        <h6>{{ dia.title() }} #1</h6>
                        <p>Sin planificar</p>
                        <button class="btn btn-sm btn-primary" onclick="crearShort('{{ dia }}', 1)">
                            <i class="fas fa-plus me-1"></i>Crear
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Short #2 del día -->
            {% set short2 = dia_shorts|selectattr('orden_dia', 'equalto', 2)|first %}
            <div class="col-md-4">
                {% if short2 %}
                <div class="card border-{{ 'success' if short2.estado == 'completado' else 'warning' if short2.estado in ['en_proceso', 'guion_generado'] else 'info' if short2.estado == 'investigacion' else 'secondary' }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title">{{ dia.title() }} #2</h6>
                            <span class="badge bg-{{ 'success' if short2.estado == 'completado' else 'warning' if short2.estado in ['en_proceso', 'guion_generado'] else 'info' if short2.estado == 'investigacion' else 'secondary' }}">
                                {{ short2.estado.replace('_', ' ').title() }}
                            </span>
                        </div>
                        <p class="card-text text-truncate">{{ short2.titulo }}</p>
                        <small class="text-muted d-block mb-2">{{ short2.tema.title() }} • VPH: {{ short2.vph_fuente|int }}</small>
                        <div class="btn-group w-100" role="group">
                            <a href="{{ url_for('ver_short', short_id=short2.id) }}" class="btn btn-sm btn-outline-primary">Ver</a>
                            <button class="btn btn-sm btn-outline-success" onclick="cambiarEstado({{ short2.id }}, 'en_proceso')">Producir</button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card border-light">
                    <div class="card-body text-center text-muted">
                        <i class="fas fa-plus-circle fa-2x mb-2"></i>
                        <h6>{{ dia.title() }} #2</h6>
                        <p>Sin planificar</p>
                        <button class="btn btn-sm btn-primary" onclick="crearShort('{{ dia }}', 2)">
                            <i class="fas fa-plus me-1"></i>Crear
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Short #3 del día -->
            {% set short3 = dia_shorts|selectattr('orden_dia', 'equalto', 3)|first %}
            <div class="col-md-4">
                {% if short3 %}
                <div class="card border-{{ 'success' if short3.estado == 'completado' else 'warning' if short3.estado in ['en_proceso', 'guion_generado'] else 'info' if short3.estado == 'investigacion' else 'secondary' }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title">{{ dia.title() }} #3</h6>
                            <span class="badge bg-{{ 'success' if short3.estado == 'completado' else 'warning' if short3.estado in ['en_proceso', 'guion_generado'] else 'info' if short3.estado == 'investigacion' else 'secondary' }}">
                                {{ short3.estado.replace('_', ' ').title() }}
                            </span>
                        </div>
                        <p class="card-text text-truncate">{{ short3.titulo }}</p>
                        <small class="text-muted d-block mb-2">{{ short3.tema.title() }} • VPH: {{ short3.vph_fuente|int }}</small>
                        <div class="btn-group w-100" role="group">
                            <a href="{{ url_for('ver_short', short_id=short3.id) }}" class="btn btn-sm btn-outline-primary">Ver</a>
                            <button class="btn btn-sm btn-outline-success" onclick="cambiarEstado({{ short3.id }}, 'en_proceso')">Producir</button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card border-light">
                    <div class="card-body text-center text-muted">
                        <i class="fas fa-plus-circle fa-2x mb-2"></i>
                        <h6>{{ dia.title() }} #3</h6>
                        <p>Sin planificar</p>
                        <button class="btn btn-sm btn-primary" onclick="crearShort('{{ dia }}', 3)">
                            <i class="fas fa-plus me-1"></i>Crear
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modal para actualizar short -->
<div class="modal fade" id="actualizarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Actualizar Short</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="actualizarForm">
                    <div class="mb-3">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="estado" name="estado">
                            <option value="pendiente">Pendiente</option>
                            <option value="en_proceso">En Proceso</option>
                            <option value="completado">Completado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Views (opcional)</label>
                        <input type="number" class="form-control" id="views" name="views" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Engagement % (opcional)</label>
                        <input type="number" class="form-control" id="engagement" name="engagement" min="0" max="100" step="0.1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URL YouTube (opcional)</label>
                        <input type="url" class="form-control" id="url_youtube" name="url_youtube" placeholder="https://youtube.com/shorts/...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas</label>
                        <textarea class="form-control" id="notas" name="notas" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarActualizacion()">Guardar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let shortIdActual = null;

function verShort(shortId) {
    window.open(`/short/${shortId}`, '_blank');
}

function cambiarEstado(shortId, nuevoEstado) {
    $.ajax({
        url: `/actualizar_short/${shortId}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ estado: nuevoEstado }),
        success: function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error al actualizar: ' + response.mensaje);
            }
        },
        error: function() {
            alert('Error de conexión');
        }
    });
}

function crearShort(dia, orden) {
    // Redirigir a buscar videos con filtros del día
    window.location.href = `/buscar_videos?dia=${dia}&orden=${orden}&semana_id={{ semana_actual.id }}`;
}

function crearShortsDia(dia, fecha) {
    if (confirm(`¿Crear los 3 shorts para ${dia} ${fecha}? Esto te llevará a la búsqueda de videos.`)) {
        window.location.href = `/planificar_dia?dia=${dia}&fecha=${fecha}&semana_id={{ semana_actual.id }}`;
    }
}

function descargarVideosPendientes() {
    const shortsPendientes = document.querySelectorAll('[data-estado="investigacion"], [data-estado="guion_generado"]').length;
    
    if (shortsPendientes === 0) {
        alert('No hay videos pendientes para descargar');
        return;
    }
    
    if (confirm(`¿Descargar ${shortsPendientes} videos pendientes?`)) {
        $.ajax({
            url: `/api/descargar_videos_masivo`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ semana_id: {{ semana_actual.id }} }),
            success: function(response) {
                if (response.success) {
                    alert(`Iniciando descarga de ${response.videos_descargados} videos...`);
                    // Actualizar progreso cada 5 segundos
                    const interval = setInterval(() => {
                        location.reload();
                    }, 5000);
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function() {
                alert('Error de conexión');
            }
        });
    }
}

function actualizarEstado(shortId) {
    shortIdActual = shortId;
    $('#actualizarModal').modal('show');
}

function guardarActualizacion() {
    if (!shortIdActual) return;
    
    const formData = {
        estado: $('#estado').val(),
        views: $('#views').val(),
        engagement: $('#engagement').val(),
        url_youtube: $('#url_youtube').val(),
        notas: $('#notas').val()
    };
    
    $.ajax({
        url: `/actualizar_short/${shortIdActual}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error al actualizar: ' + response.mensaje);
            }
        },
        error: function() {
            alert('Error de conexión');
        }
    });
}
</script>
{% endblock %}